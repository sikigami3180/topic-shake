<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <style type="text/css">
      input {
        border: none;
      }
      .data {
        width: 320px;
        margin: 1em auto;
      }
      .data dt,
      .data dd {
        font-size: 0.7em;
        line-height: 1.1;
        margin: 0;
        padding: 0;
      }
      .data dt {
        font-weight: 700;
      }
      .data dd {
        margin-left: 16px;
      }
      .nav_wrapper {
        display: flex;
        justify-content: space-around;
        cursor: pointer;
      }
      .nav_wrapper a {
        width: 20%;
        text-align: center;
        transition: 0.5s;
      }
      .twitter {
        border: 1px solid #1ea1f2;
        color: #1ea1f2;
      }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link
      href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
    />
  </head>

  <body>
    <h1>話題に困ったら振るやつ</h1>
    <!--<button onclick="permission_request();">
      加速度センサーへのアクセス許可
    </button>-->
    <div class="nav_wrapper" onclick="permission_request();">
      <a class="twitter">
        <i class="fa fa-cogs" aria-hidden="true"></i>
        permission
        <i class="fa fa-cogs" aria-hidden="true"></i>
      </a>
    </div>

    <div id="power">
      ppp
    </div>
    <div id="num">
      nnn
    </div>
    <div id="buf_power">
      nnn
    </div>

    <form name="data" class="data">
      <dl>
        <dt>acceleration.x</dt>
        <dd>
          <svg xmlns="http://www.w3.org/2000/svg" width="300" height="8">
            <rect x="0" y="0" width="300" height="8" fill="#eee" />
            <rect x="150" y="0" width="0" height="8" fill="#f90" id="bar-x" />
          </svg>
        </dd>

        <dt>acceleration.y</dt>
        <dd>
          <svg xmlns="http://www.w3.org/2000/svg" width="300" height="8">
            <rect x="0" y="0" width="300" height="8" fill="#eee" />
            <rect x="150" y="0" width="0" height="8" fill="#f90" id="bar-y" />
          </svg>
        </dd>

        <dt>acceleration.z</dt>
        <dd>
          <svg xmlns="http://www.w3.org/2000/svg" width="300" height="8">
            <rect x="0" y="0" width="300" height="8" fill="#eee" />
            <rect x="150" y="0" width="0" height="8" fill="#f90" id="bar-z" />
          </svg>
        </dd>
      </dl>
    </form>

    <script type="text/javascript">
      let num = 0;
      let buf_power = 0;

      //let power = 0;
      /*let suppression_flag = false;
      const countUp = () => {
        suppression_flag = false;
      }
      setInterval(countUp, 500);*/
      let state = "ready";

      function add_event_listener() {
        window.addEventListener(
          "devicemotion",
          function (event) {
            const d = {};
            d["x"] = event.acceleration.x;
            d["y"] = event.acceleration.y;
            d["z"] = event.acceleration.z;
            const power = d["x"] * d["x"] + d["y"] * d["y"] + d["z"] * d["z"];
            
            if (power > 10 && state === "ready") {
              state = "moving";
              buf_power = 0;
            } else if (power < 10 && state === "moving") {
              num += 1;
              state = "ready";
              const res = document.getElementById("num");
              res.innerText = String(num);
            } else if (state === "moving") {
              if (power > buf_power) {
                buf_power = power;
              }
              const res = document.getElementById("buf_power");
              res.innerText = String(buf_power);
            }

            // 棒グラフ ------
            const center = 150;
            const zoom = 10;
            for (const key in d) {
              const barId = "bar-" + key;
              document
                .getElementById(barId)
                .setAttribute("width", Math.abs(d[key]) * zoom);
              if (d[key] < 0) {
                document
                  .getElementById(barId)
                  .setAttribute("x", center - Math.abs(d[key]) * zoom);
                document.getElementById(barId).setAttribute("fill", "#6cf");
              } else {
                document.getElementById(barId).setAttribute("x", center);
                document.getElementById(barId).setAttribute("fill", "#f90");
              }
            }
          },
          true
        );
      }
      /*function post_function(result_string) {
        if (result_string === "granted") {
          // ユーザが許可した場合、文字列"granted"が返る
          add_event_listener();
        } else if (result_string === "denied") {
          // ユーザが拒否した場合、文字列"denied"が返る
        }
      }*/
      function permission_request() {
        if (
          DeviceOrientationEvent &&
          DeviceOrientationEvent.requestPermission &&
          typeof DeviceOrientationEvent.requestPermission === "function"
        ) {
          DeviceMotionEvent.requestPermission().then(add_event_listener);
        } else {
          add_event_listener();
        }
        console.log("aaaaaaa")
      }
    </script>
  </body>
</html>
